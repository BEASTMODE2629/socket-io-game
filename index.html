<!doctype html>
<html>
  <head>
    <title>Socket Game Blueprint</title>
    <!-- <link rel="stylesheet" href='styles.css'> -->
    <style>
      #game {
        background-color: lightgray;
        border: 1px solid black;
      }
    </style>
  </head>
  <body>
  <!-- Size is 10 greater than actual size -->
  <canvas id="game" width="510" height="510"></canvas>
  <div id='playerCount'></div>
  <div id='scores'></div>


    <script src="/socket.io/socket.io.js"></script>
    <script src="https://code.jquery.com/jquery-1.11.1.js"></script>
    <script src='./game.js'></script>
    <script>
      $(function () {
        var socket = io();
        var canvas = document.getElementById('game');
        var ctx = canvas.getContext('2d');
        // var players = {}; // this is magically defined in game.js

        socket.on('gameStateUpdate', updateGameState);

        function updateGameState(gameState) {
          // update local state to match state on server
          players = gameState
          // draw stuff
          ctx.clearRect(0, 0, canvas.width, canvas.height);

          // set score info
          document.getElementById('playerCount').innerHTML = "Player count: " + Object.keys(gameState).length
          var scores = ''
          Object.values(gameState).forEach((value, index) => {
            scores += "<p><span style='background-color: " + value.colour + ";'>Player " + String(index+1) + "</span>: " + value.score + "</p>"
          })
          document.getElementById('scores').innerHTML = scores

          // draw players
          Object.keys(gameState).forEach((playerId) => {
            let player = gameState[playerId]
            ctx.fillStyle = player.colour;
            player.squares.forEach((square) => {
              ctx.fillRect(square.x * 10, square.y * 10, 10,10);
            })
          })
        }

        // key handling
        $('html').keydown(function(e) {
          console.log(players)
          if (e.key == "ArrowDown") {
            socket.emit('down', players);
            accelPlayer(socket.id, 0, 1)
          } else if (e.key == "ArrowUp") {
            socket.emit('up', players);
            accelPlayer(socket.id, 0, -1)
          } else if (e.key == "ArrowLeft") {
            socket.emit('left', players);
            accelPlayer(socket.id, -1, 0)
          } else if (e.key == "ArrowRight") {
            socket.emit('right', players);
            accelPlayer(socket.id, 1, 0)
          }
        })

        function gameLoop() {
          // move everyone around
          Object.keys(players).forEach((playerId) => {
            let player = players[playerId]
            movePlayer(playerId)
          })

          // draw stuff
          updateGameState(players)
        }

        setInterval(gameLoop, 25)

      });
    </script>
  </body>
</html>
