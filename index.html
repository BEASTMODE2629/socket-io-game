<!doctype html>
<html>
  <head>
    <title>Socket Game Blueprint</title>
    <!-- <link rel="stylesheet" href='styles.css'> -->
    <style>
      #game {
        background-color: lightgray;
        border: 1px solid black;
      }
    </style>
  </head>
  <body>
  <div id='playerCount'></div>
  <div id='scores'></div>
  <!-- Size is 10 greater than actual size -->
  <canvas id="game" width="510" height="510"></canvas>


    <script src="/socket.io/socket.io.js"></script>
    <script src="https://code.jquery.com/jquery-1.11.1.js"></script>
    <script>
      $(function () {
        var socket = io();
        var canvas = document.getElementById('game');
        var ctx = canvas.getContext('2d');

        socket.on('gameStateUpdate', updateGameState);

        function updateGameState(gameState) {
          players = gameState // update local state to match state on server

          // draw stuff
          ctx.clearRect(0, 0, canvas.width, canvas.height);

          // set score info
          document.getElementById('playerCount').innerHTML = "Player count: " + Object.keys(gameState).length
          var scores = ''
          Object.values(gameState).forEach((value, index) => {
            scores += "<p><span style='background-color: " + value.colour + ";'>Player " + String(index+1) + "</span>: " + value.score + "</p>"
          })
          document.getElementById('scores').innerHTML = scores

          // draw players
          Object.keys(gameState).forEach((playerId) => {
            let player = gameState[playerId]
            ctx.fillStyle = player.colour;
            player.squares.forEach((square) => {
              ctx.fillRect(square.x * 10, square.y * 10, 10,10);
            })
          })
        }

        // key handling
        $('html').keydown(function(e) {
          console.log(e)
          if (e.key == "ArrowDown") {
            socket.emit('down', players);
            accelPlayer(socket.id, 0, 1)
          } else if (e.key == "ArrowUp") {
            socket.emit('up', players);
            accelPlayer(socket.id, 0, -1)
          } else if (e.key == "ArrowLeft") {
            socket.emit('left', players);
            accelPlayer(socket.id, -1, 0)
          } else if (e.key == "ArrowRight") {
            socket.emit('right', players);
            accelPlayer(socket.id, 1, 0)
          }
        })

        // game code


        var players = {}

        const gameSize = 50; // 50-tile grid of possible locations

        function isValidSquare(newSquare) {
          // bounds check
          if (newSquare.x < 0 || newSquare.x > gameSize) {
            return false
          }
          if (newSquare.y < 0 || newSquare.y > gameSize) {
            return false
          }
          // collision check
          var hasCollided = false
          // console.log("new square", newSquare)
          Object.keys(players).forEach((key) => {
            player = players[key] 
          // })
          // .forEach((player) => {
            player.squares.forEach((square) => {
              if (square.x == newSquare.x && square.y == newSquare.y) {
                hasCollided = true
              }
            })
          })
          if (hasCollided) { return false }
          return true
        }

        function movePlayer(id) {

          var player = players[id]
          var lastSquare = player.squares[player.squares.length - 1]

          var newSquare = {
            x: lastSquare.x + player.accel.x,
            y: lastSquare.y + player.accel.y
          }
          if (isValidSquare(newSquare)) {
            // move the player and increment score
            player.squares.push(newSquare)
            if (player.squares.length % 30 == 0) { player.score++ }
          } else {
            // reset the player
            player.squares = [player.squares[player.squares.length - 1]]
            if (player.score >= 5) { player.score -= 5 }
          }
        }

        function accelPlayer(id, x, y) {
          players[id].accel.x = x
          players[id].accel.y = y
        }

        // thanks SO
        function stringToColour(str) {
          var hash = 0;
          for (var i = 0; i < str.length; i++) {
            hash = str.charCodeAt(i) + ((hash << 5) - hash);
          }
          var colour = '#';
          for (var i = 0; i < 3; i++) {
            var value = (hash >> (i * 8)) & 0xFF;
            colour += ('00' + value.toString(16)).substr(-2);
          }
          return colour;
        }

        function gameLoop() {
          // move everyone around
          Object.keys(players).forEach((playerId) => {
            let player = players[playerId]
            movePlayer(playerId)
          })

          // draw stuff
          updateGameState(players)
        }

        setInterval(gameLoop, 30)



      });
    </script>
  </body>
</html>
